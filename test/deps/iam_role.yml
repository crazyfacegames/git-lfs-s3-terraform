---
AWSTemplateFormatVersion: "2010-09-09"
Description: IAM User for integration teseting
Outputs:
  BoundaryPolicyArn:
    Description: Arn of IAM Managed Policy for user-created roles
    Value:
      Ref: BoundaryPolicy
  RoleArn:
    Description: Arn of IAM Role
    Value:
      Fn::GetAtt:
        - Role
        - Arn
Parameters:
  EnvironmentName:
    Description: "Name of environment for the user (used as a prefix to the name)"
    Type: String
  RepoName:
    Description: "Name of GitHub repo"
    Type: String
  ServiceName:
    Description: "Name of project"
    Type: String
Resources:
  BoundaryPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Role boundary policy
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/lambda/
                    - Ref: ServiceName
                    - -inttest*
          - Action:
              - cognito-idp:AdminInitiateAuth
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":cognito-idp:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :userpool/*
          - Action:
              - dynamodb:DeleteItem
              - dynamodb:GetItem
              - dynamodb:PutItem
              - dynamodb:Query
              - dynamodb:Scan
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":dynamodb:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :table/
                    - Ref: ServiceName
                    - -inttest*
  PermissionsPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Role permissions policy
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - apigateway:GET
            Effect: Allow
            Resource: "*"
          - Action:
              - apigateway:DELETE
              - apigateway:POST
              - apigateway:PUT
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":apigateway:"
                    - Ref: AWS::Region
                    - "::/restapis*"
          - Action:
              - cognito-idp:CreateUserPoolClient
              - cognito-idp:DeleteUserPoolClient
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":cognito-idp:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - ":userpool/*"
          - Action:
              - cognito-idp:CreateUserPool
              - cognito-idp:TagResource
            Condition:
              StringLike:
                "aws:RequestTag/STAGE": "inttest*"
            Effect: Allow
            Resource: "*"
          - Action:
              - cognito-idp:DeleteUserPool
            Condition:
              StringLike:
                "aws:ResourceTag/STAGE": "inttest*"
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":cognito-idp:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - ":userpool/*"
          - Action:
              - cloudformation:ValidateTemplate
            Effect: Allow
            Resource: "*"
          - Action:
              - cloudformation:CreateStack
              - cloudformation:CreateChangeSet
              - cloudformation:DeleteChangeSet
              - cloudformation:DeleteStack
              - cloudformation:DescribeChangeSet
              - cloudformation:DescribeStackEvents
              - cloudformation:DescribeStackResource
              - cloudformation:DescribeStacks
              - cloudformation:ExecuteChangeSet
              - cloudformation:ListStackResources
              - cloudformation:TagResource
              - cloudformation:UntagResource
              - cloudformation:UpdateStack
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":cloudformation:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :stack/
                    - Ref: ServiceName
                    - -inttest*
          - Action:
              - dynamodb:CreateTable
              - dynamodb:DeleteItem
              - dynamodb:DeleteTable
              - dynamodb:DescribeTable
              - dynamodb:GetItem
              - dynamodb:ListTagsOfResource
              - dynamodb:PutItem
              - dynamodb:TagResource
              - dynamodb:UntagResource
              - dynamodb:UpdateTable
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":dynamodb:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :table/
                    - Ref: ServiceName
                    - -inttest*
          - Action:
              - iam:AttachRolePolicy
              - iam:CreateRole
              - iam:DetachRolePolicy
              - iam:PutRolePolicy
            Effect: Allow
            Condition:
              StringEquals:
                "iam:PermissionsBoundary":
                  Ref: BoundaryPolicy
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":iam::"
                    - Ref: AWS::AccountId
                    - :role/
                    - Ref: ServiceName
                    - -inttest*
          - Action:
              - iam:DeleteRole
              - iam:DeleteRolePolicy
              - iam:GetRole
              - iam:GetRolePolicy
              - iam:ListAttachedRolePolicies
              - iam:ListInstanceProfilesForRole
              - iam:ListRolePolicies
              - iam:ListRoleTags
              - iam:PassRole
              - iam:TagRole
              - iam:UntagRole
              - iam:UpdateRoleDescription
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":iam::"
                    - Ref: AWS::AccountId
                    - :role/
                    - Ref: ServiceName
                    - -inttest*
          - Action:
              - lambda:CreateFunction
              - lambda:DeleteFunction
              - lambda:GetFunction
              - lambda:GetFunctionCodeSigningConfig
              - lambda:InvokeFunction
              - lambda:ListTags
              - lambda:ListVersionsByFunction
              - lambda:PublishVersion
              - lambda:TagResource
              - lambda:UntagResource
              - lambda:UpdateFunctionCode
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":lambda:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - ":function:"
                    - Ref: ServiceName
                    - -inttest*
          - Action:
              - lambda:AddPermission
              - lambda:RemovePermission
            Condition:
              StringEquals:
                "lambda:Principal": "apigateway.amazonaws.com"
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":lambda:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - ":function:"
                    - Ref: ServiceName
                    - -inttest*
          - Action:
              - logs:CreateLogGroup
              - logs:DeleteLogGroup
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/lambda/
                    - Ref: ServiceName
                    - -inttest*
          - Action:
              - s3:CreateBucket
              - s3:DeleteBucket
              - s3:DeleteBucketPolicy
              - s3:DeleteObject
              - s3:DeleteObjectVersion
              - s3:GetBucketVersioning
              - s3:GetEncryptionConfiguration
              - s3:GetLifecycleConfiguration
              - s3:GetBucketPolicy
              - s3:GetBucketPolicyStatus
              - s3:GetObject
              - s3:HeadObject
              - s3:ListBucket
              - s3:ListBucketVersions
              - s3:PutBucketVersioning
              - s3:PutBucketPolicy
              - s3:PutEncryptionConfiguration
              - s3:PutLifecycleConfiguration
              - s3:PutObject
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: ServiceName
                    - -inttest*
  GithubOidc:
    Type: AWS::IAM::OIDCProvider
    Properties:
      ClientIdList: 
        - !Sub https://github.com/${RepoName}
      Tags:
        - Key: Environment
          Value:
            Ref: EnvironmentName
        - Key: Project
          Value:
            Ref: ServiceName
        - Key: Purpose
          Value: Integration Testing
      ThumbprintList: [a031c46782e6e6c662c2c87c76da9aa62ccabd8e]
      Url: https://vstoken.actions.githubusercontent.com
  Role:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - Ref: PermissionsPolicy
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Action: sts:AssumeRoleWithWebIdentity
            Principal:
              Federated: !Ref GithubOidc
            Condition:
              StringLike:
                vstoken.actions.githubusercontent.com:sub: !Sub repo:${RepoName}:*
      Tags:
        - Key: Environment
          Value:
            Ref: EnvironmentName
        - Key: Project
          Value:
            Ref: ServiceName
        - Key: Purpose
          Value: Integration Testing

